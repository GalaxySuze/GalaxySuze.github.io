<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<title>张阿简博客</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="description" content="Kill Time, Or Kiss Time"/>
<meta name="keywords" content="Kill Time, Or Kiss Time"/>
<link rel="shortcut icon" href="https://zhangajian.com/favicon.ico">
<link rel="stylesheet" href="https://zhangajian.com/styles/main.css">


<!-- Comment -->

    
        <link href="https://cdn.bootcss.com/gitalk/1.5.0/gitalk.min.css" rel="stylesheet">
    

    


<link href="https://cdn.bootcss.com/font-awesome/5.11.2/css/all.min.css" rel="stylesheet">



</head>
<body class="home-template">
<div id="page" class="site">

    <header class="site-header">
    <h1 class="site-title"><a href="https://zhangajian.com">张阿简博客</a></h1>
    <a class="sidebar-toggle"><span class="screen-reader-text">Menu</span><span class="icon" aria-hidden="true"></span></a>
</header>

<aside class="sidebar">
    <div class="sidebar-scrollable">
        <div class="inner">
            <div class="widget-area">
                <!-- 菜单 -->
                <nav class="site-navigation">
                    <h2>张阿简博客</h2>
                    <ul class="menu">
                        
                            <li class="menu-item home current-menu-item">
                                <a href="/"
                                
                                >首页</a>
                            </li>
                        
                            <li class="menu-item home current-menu-item">
                                <a href="/archives"
                                
                                >归档</a>
                            </li>
                        
                            <li class="menu-item home current-menu-item">
                                <a href="https://zhangajian.com/post/tu-lang/"
                                
                                >图廊</a>
                            </li>
                        
                            <li class="menu-item home current-menu-item">
                                <a href="https://zhangajian.com/post/you-lian/"
                                
                                >友链</a>
                            </li>
                        
                    </ul>
                </nav>

                <section class="widget widget-about">
                    <h2 class="widget-title">关于</h2>
                    <p>Kill Time, Or Kiss Time</p>
                </section>

                <section class="widget widget-tags">
                    <h2 class="widget-title">标签</h2>
                    <div class="tagcloud">
                        
                            <a href="https://zhangajian.com/tag/-6RH_hF5V" class="button">
                                Gridea
                                <span aria-hidden="true"><span class="line left"></span><span class="line top"></span><span class="line right"></span><span class="line bottom"></span></span>
                            </a>
                        
                            <a href="https://zhangajian.com/tag/ISfc6GmDv1" class="button">
                                主题
                                <span aria-hidden="true"><span class="line left"></span><span class="line top"></span><span class="line right"></span><span class="line bottom"></span></span>
                            </a>
                        
                            <a href="https://zhangajian.com/tag/wa6VE0See" class="button">
                                原创
                                <span aria-hidden="true"><span class="line left"></span><span class="line top"></span><span class="line right"></span><span class="line bottom"></span></span>
                            </a>
                        
                            <a href="https://zhangajian.com/tag/FUUIh5fRu" class="button">
                                阅读
                                <span aria-hidden="true"><span class="line left"></span><span class="line top"></span><span class="line right"></span><span class="line bottom"></span></span>
                            </a>
                        
                            <a href="https://zhangajian.com/tag/fb3yEkNaz" class="button">
                                Supervisor
                                <span aria-hidden="true"><span class="line left"></span><span class="line top"></span><span class="line right"></span><span class="line bottom"></span></span>
                            </a>
                        
                            <a href="https://zhangajian.com/tag/laravel" class="button">
                                Laravel
                                <span aria-hidden="true"><span class="line left"></span><span class="line top"></span><span class="line right"></span><span class="line bottom"></span></span>
                            </a>
                        
                            <a href="https://zhangajian.com/tag/TnE9j9p54" class="button">
                                生活
                                <span aria-hidden="true"><span class="line left"></span><span class="line top"></span><span class="line right"></span><span class="line bottom"></span></span>
                            </a>
                        
                            <a href="https://zhangajian.com/tag/2Lrsz8nQ5" class="button">
                                Java
                                <span aria-hidden="true"><span class="line left"></span><span class="line top"></span><span class="line right"></span><span class="line bottom"></span></span>
                            </a>
                        
                            <a href="https://zhangajian.com/tag/linux" class="button">
                                Linux
                                <span aria-hidden="true"><span class="line left"></span><span class="line top"></span><span class="line right"></span><span class="line bottom"></span></span>
                            </a>
                        
                            <a href="https://zhangajian.com/tag/Q1TPBCeTZ" class="button">
                                Minecraft
                                <span aria-hidden="true"><span class="line left"></span><span class="line top"></span><span class="line right"></span><span class="line bottom"></span></span>
                            </a>
                        
                            <a href="https://zhangajian.com/tag/screen" class="button">
                                screen
                                <span aria-hidden="true"><span class="line left"></span><span class="line top"></span><span class="line right"></span><span class="line bottom"></span></span>
                            </a>
                        
                            <a href="https://zhangajian.com/tag/R9XMeHPGI" class="button">
                                Mac
                                <span aria-hidden="true"><span class="line left"></span><span class="line top"></span><span class="line right"></span><span class="line bottom"></span></span>
                            </a>
                        
                            <a href="https://zhangajian.com/tag/7GuO-rABn" class="button">
                                Certbot
                                <span aria-hidden="true"><span class="line left"></span><span class="line top"></span><span class="line right"></span><span class="line bottom"></span></span>
                            </a>
                        
                            <a href="https://zhangajian.com/tag/32-ELgkvl" class="button">
                                HTTPS
                                <span aria-hidden="true"><span class="line left"></span><span class="line top"></span><span class="line right"></span><span class="line bottom"></span></span>
                            </a>
                        
                            <a href="https://zhangajian.com/tag/nginx" class="button">
                                Nginx
                                <span aria-hidden="true"><span class="line left"></span><span class="line top"></span><span class="line right"></span><span class="line bottom"></span></span>
                            </a>
                        
                            <a href="https://zhangajian.com/tag/gWr_Ce0M-" class="button">
                                PHP
                                <span aria-hidden="true"><span class="line left"></span><span class="line top"></span><span class="line right"></span><span class="line bottom"></span></span>
                            </a>
                        
                            <a href="https://zhangajian.com/tag/WU4oQ_US9" class="button">
                                WordPress
                                <span aria-hidden="true"><span class="line left"></span><span class="line top"></span><span class="line right"></span><span class="line bottom"></span></span>
                            </a>
                        
                            <a href="https://zhangajian.com/tag/zpAo_gez-" class="button">
                                Mysql
                                <span aria-hidden="true"><span class="line left"></span><span class="line top"></span><span class="line right"></span><span class="line bottom"></span></span>
                            </a>
                        
                            <a href="https://zhangajian.com/tag/XljxheWyB" class="button">
                                Composer
                                <span aria-hidden="true"><span class="line left"></span><span class="line top"></span><span class="line right"></span><span class="line bottom"></span></span>
                            </a>
                        
                            <a href="https://zhangajian.com/tag/Zo5YAjmh-" class="button">
                                设计模式
                                <span aria-hidden="true"><span class="line left"></span><span class="line top"></span><span class="line right"></span><span class="line bottom"></span></span>
                            </a>
                        
                            <a href="https://zhangajian.com/tag/f8yREx6Zn" class="button">
                                Redis
                                <span aria-hidden="true"><span class="line left"></span><span class="line top"></span><span class="line right"></span><span class="line bottom"></span></span>
                            </a>
                        
                    </div>
                </section>

            </div>
            <a class="sidebar-toggle"><span class="screen-reader-text">Close</span><span class="icon" aria-hidden="true"></span></a>
        </div>
    </div>
</aside>


    <main class="site-main">
        <div class="site-content">
            <article class="post tag-getting-started">
                <header class="cover post-header">
                    <div class="cover-bg" >

                        
                            <img srcset="https://blog-img-hosting.oss-cn-shanghai.aliyuncs.com/blog/article_cover/c-70.jpg 300w, https://blog-img-hosting.oss-cn-shanghai.aliyuncs.com/blog/article_cover/c-70.jpg 600w, https://blog-img-hosting.oss-cn-shanghai.aliyuncs.com/blog/article_cover/c-70.jpg 800w, https://blog-img-hosting.oss-cn-shanghai.aliyuncs.com/blog/article_cover/c-70.jpg 1600w, https://blog-img-hosting.oss-cn-shanghai.aliyuncs.com/blog/article_cover/c-70.jpg 2000w"
                                 sizes="100vw" src="https://blog-img-hosting.oss-cn-shanghai.aliyuncs.com/blog/article_cover/c-70.jpg" alt="这个周末上线一个帮朋友做的网站，遇到挺多坑，记录一下"/>
                        

                    </div>
                    <div class="cover-content">
                        <div class="inner">
                            <div class="post-tags">
                                
                                    
                                        <a href="https://zhangajian.com/tag/zpAo_gez-">Mysql&nbsp;&nbsp;</a>
                                    
                                        <a href="https://zhangajian.com/tag/laravel">Laravel&nbsp;&nbsp;</a>
                                    
                                        <a href="https://zhangajian.com/tag/XljxheWyB">Composer&nbsp;&nbsp;</a>
                                    
                                        <a href="https://zhangajian.com/tag/gWr_Ce0M-">PHP&nbsp;&nbsp;</a>
                                    
                                        <a href="https://zhangajian.com/tag/nginx">Nginx&nbsp;&nbsp;</a>
                                    
                                        <a href="https://zhangajian.com/tag/linux">Linux&nbsp;&nbsp;</a>
                                    
                                        <a href="https://zhangajian.com/tag/wa6VE0See">原创&nbsp;&nbsp;</a>
                                    
                                
                            </div>
                            <h1 class="post-title" style="color: #ffffff; font-size: 3em;">这个周末上线一个帮朋友做的网站，遇到挺多坑，记录一下</h1>
                            <div class="post-meta">
                                <span class="post-meta-wrap">
                                    <img class="author-avatar"
                                         srcset="https://zhangajian.com/media/images/avatar.png, https://zhangajian.com/media/images/avatar.png 2x"
                                         src="https://zhangajian.com/media/images/avatar.png" alt=""/>
                                    <span class="post-author">3818字</span>
                                    <time class="published"
                                          datetime="2018-05-07">2018-05-07</time>
                                </span>
                                <div class="reading-time">19 min read</div>
                            </div>
                            <a href="#post-content" class="arrow-down" data-scroll><span class="screen-reader-text">Scroll Down</span></a>
                        </div>
                    </div>
                </header>
                <div class="inner">

                    <div id="post-content" class="post-content">
                        <p style="margin-top: 62px;">
                            <h1 id="网站上线流程">网站上线流程</h1>
<ul>
<li>
<h4 id="购买服务器目前选择的是阿里云服务器选择的是入门型1核1g实例">购买服务器，目前选择的是阿里云服务器，选择的是入门型1核1G实例</h4>
</li>
<li>
<h5 id="配置ssh连接">配置SSH连接</h5>
<blockquote>
<ul>
<li>增加本机ssh连接配置，一般激活实例后，ssh的22端口是默认开放的，可以直接通过root用户进行登录配置部署环境，</li>
</ul>
</blockquote>
<blockquote>
<ul>
<li>登录到服务器后，将自己的公钥加入到 <em>~/.ssh/authorized_keys</em> 配置文件中就可直接通过秘钥进行登录</li>
</ul>
</blockquote>
</li>
<li>
<h5 id="服务器配置">服务器配置</h5>
<blockquote>
<ul>
<li>服务器系统版本：CentOS Linux release 7.4.1708 (Core)</li>
</ul>
</blockquote>
<blockquote>
<ul>
<li>内存：1G</li>
</ul>
</blockquote>
<blockquote>
<ul>
<li>CPU：1核</li>
</ul>
</blockquote>
<blockquote>
<ul>
<li>硬盘：40G</li>
</ul>
</blockquote>
<h1 id="一-安装mysql55">一. 安装Mysql5.5</h1>
<p>因为服务器配置有点低，所以这边选择安装比较低的mysql版本。从CentOS 7.0发布以来，yum源中开始使用mariadb来代替MySQL的安装。即使你输入的是yum install mysql , 显示的也是mariadb的安装内容，因此，如果使用yum安装MySQL的话，就需要去下载官方指定的yum源。</p>
<p>网址： https://dev.mysql.com/downloads/repo/yum/。</p>
<p><em>1. 先卸载mariadb，查看mariadb是否已经安装</em></p>
<pre><code>
[root@iZbp17dq2xryqoixibq5u1Z ~]#  yum list installed | grep mariadb

mariadb-libs.x86_64                     1:5.5.56-2.el7                 @anaconda

</code></pre>
<p>进行卸载</p>
<pre><code>
[root@iZbp17dq2xryqoixibq5u1Z ~]# yum -y remove mariadb*

Loaded plugins: fastestmirror

Resolving Dependencies

......   省略过程



Removed:

  mariadb-libs.x86_64 1:5.5.56-2.el7



Dependency Removed:

  postfix.x86_64 2:2.10.1-6.el7                                                                redhat-lsb-core.x86_64 0:4.1-27.el7.centos.1



Complete!

</code></pre>
<p><em>2. 获取yum源和数据库安装，官方指南</em></p>
<pre><code>
wget http://repo.mysql.com/yum/mysql-5.5-community/el/6/x86_64/mysql-community-release-el6-5.noarch.rpm  #MySQL5.5yum源

</code></pre>
<p>安装yum源</p>
<pre><code>
rpm -ivh mysql-5.5-community/el/6/x86_64/mysql-community-release-el6-5.noarch.rpm 

</code></pre>
<p>安装好yum源后，需要修改一下配置文件，文件路径在 <em>/etc/yum.repos.d/mysql-community.repo</em>，要将5.5的enabled改为1，而5.6的enabled改为0</p>
<pre><code>
# Enable to use MySQL 5.5

[mysql55-community]

name=MySQL 5.5 Community Server

baseurl=http://repo.mysql.com/yum/mysql-5.5-community/el/6/$basearch/

enabled=1

gpgcheck=1

gpgkey=file:/etc/pki/rpm-gpg/RPM-GPG-KEY-mysql



# Enable to use MySQL 5.6

[mysql56-community]

name=MySQL 5.6 Community Server

baseurl=http://repo.mysql.com/yum/mysql-5.6-community/el/6/$basearch/

enabled=0

gpgcheck=1

gpgkey=file:/etc/pki/rpm-gpg/RPM-GPG-KEY-mysql



# Note: MySQL 5.7 is currently in development. For use at your own risk.

# Please read with sub pages: https://dev.mysql.com/doc/relnotes/mysql/5.7/en/

[mysql57-community-dmr]

name=MySQL 5.7 Community Server Development Milestone Release

baseurl=http://repo.mysql.com/yum/mysql-5.7-community/el/6/$basearch/

enabled=0

gpgcheck=1

gpgkey=file:/etc/pki/rpm-gpg/RPM-GPG-KEY-mysql

</code></pre>
<p>修改后保存退出，开始安装MySQL。在安装之前，可以查看下是否已有MySQL可安装文件</p>
<pre><code>
[root@iZbp17dq2xryqoixibq5u1Z ~]# yum repolist enabled | grep &quot;mysql.-community.&quot;

mysql-connectors-community/x86_64 MySQL Connectors Community                  49

mysql-tools-community/x86_64      MySQL Tools Community                       61

mysql55-community/x86_64          MySQL 5.5 Community Server                 449

</code></pre>
<p><em>3. 安装mysql</em></p>
<pre><code>
# 安装client，devel，server

yum install mysql-community-client mysql-community-devel mysql-community-server

</code></pre>
<p>安装完毕后，可以查看下当前mysql版本</p>
<pre><code>
[root@iZbp17dq2xryqoixibq5u1Z ~]# rpm -qi mysql-community-server

Name        : mysql-community-server

Version     : 5.5.60

Release     : 2.el6

Architecture: x86_64

Install Date: 2018年05月05日 星期六 16:26:00

......

</code></pre>
<p><em>4. 启动mysql</em></p>
<p>执行 <em>service mysqld start</em> 启动mysql</p>
<pre><code>
[root@iZbp17dq2xryqoixibq5u1Z ~]# service mysqld start

Starting mysqld (via systemctl):                           [  OK  ]

</code></pre>
<p>ok，mysql安装完毕</p>
<blockquote>
<p>常用命令：</p>
</blockquote>
<blockquote></blockquote>
<blockquote>
<p><em>systemctl start mysqld    #启动mysqld</em></p>
</blockquote>
<blockquote></blockquote>
<blockquote>
<p><em>systemctl stop mysqld    #停止mysqld</em></p>
</blockquote>
<blockquote></blockquote>
<blockquote>
<p><em>systemctl restart mysqld    #重启mysqld</em></p>
</blockquote>
<blockquote></blockquote>
<blockquote>
<p><em>systemctl enable mysqld   #设置开机启动</em></p>
</blockquote>
<blockquote></blockquote>
<blockquote>
<p><em>systemctl status mysqld    #查看 MySQL Server 状态</em></p>
</blockquote>
<p><em>5. 数据库安全设置</em></p>
<p>设置mysql root账户密码</p>
<pre><code>
# mysqladmin -u root password 'new password'

</code></pre>
<p>重新登录mysql报如下错误</p>
<pre><code>
ERROR 1045 (28000): Access denied for user 'root'@'localhost' (using password: YES)

</code></pre>
<p>执行如下命令进行解决</p>
<pre><code>
[root@iZbp17dq2xryqoixibq5u1Z ~]# systemctl stop mysqld    关闭mysql服务

[root@iZbp17dq2xryqoixibq5u1Z ~]# mysqld --user=root --skip-grant-tables &amp;    关闭skip-grant-tables

[1] 32163

[root@iZbp17dq2xryqoixibq5u1Z ~]# 180505 16:57:08 [Note] mysqld (mysqld 5.5.60) starting as process 32163 ...

180505 16:57:08 [Note] Plugin 'FEDERATED' is disabled.

180505 16:57:08 InnoDB: The InnoDB memory heap is disabled

180505 16:57:08 InnoDB: Mutexes and rw_locks use GCC atomic builtins

180505 16:57:08 InnoDB: Compressed tables use zlib 1.2.3

180505 16:57:08 InnoDB: Using Linux native AIO

180505 16:57:08 InnoDB: Initializing buffer pool, size = 128.0M

180505 16:57:08 InnoDB: Completed initialization of buffer pool

180505 16:57:08 InnoDB: highest supported file format is Barracuda.

180505 16:57:08  InnoDB: Waiting for the background threads to start

180505 16:57:09 InnoDB: 5.5.60 started; log sequence number 1595675

180505 16:57:09 [Note] Server hostname (bind-address): '0.0.0.0'; port: 3306

180505 16:57:09 [Note]   - '0.0.0.0' resolves to '0.0.0.0';

180505 16:57:09 [Note] Server socket created on IP: '0.0.0.0'.

180505 16:57:09 [Note] mysqld: ready for connections.

Version: '5.5.60'  socket: '/var/lib/mysql/mysql.sock'  port: 3306  MySQL Community Server (GPL)

mysql -u root mysql    空密码登入

Reading table information for completion of table and column names

You can turn off this feature to get a quicker startup with -A



Welcome to the MySQL monitor.  Commands end with ; or \g.

Your MySQL connection id is 1

Server version: 5.5.60 MySQL Community Server (GPL)



Copyright (c) 2000, 2018, Oracle and/or its affiliates. All rights reserved.



Oracle is a registered trademark of Oracle Corporation and/or its

affiliates. Other names may be trademarks of their respective

owners.



Type 'help;' or '\h' for help. Type '\c' to clear the current input statement.



mysql&gt; UPDATE user SET authentication_string=PASSWORD('new password') where USER='root';   重新设置root密码

Query OK, 4 rows affected (0.00 sec)

Rows matched: 4  Changed: 4  Warnings: 0



mysql&gt; FLUSH PRIVILEGES;   刷新设置

Query OK, 0 rows affected (0.00 sec)



mysql&gt; quit

Bye

</code></pre>
<h1 id="二-安装php环境">二. 安装PHP环境</h1>
<p><em>1. 开始安装PHP和PHP-FPM</em></p>
<p>首先安装EPEL。EPEL即Extra Packages for Enterprise Linux的简称，是为企业级Linux提供的一组高质量的额外软件包</p>
<pre><code>
yum -y install epel-release

</code></pre>
<p>安装PHP和PHP-FPM</p>
<pre><code>
yum -y install php php-fpm

</code></pre>
<p>查看PHP版本</p>
<pre><code>
[root@iZbp17dq2xryqoixibq5u1Z ~]# php -v

PHP 5.4.16 (cli) (built: Mar  7 2018 13:34:47)

Copyright (c) 1997-2013 The PHP Group

Zend Engine v2.4.0, Copyright (c) 1998-2013 Zend Technologies

</code></pre>
<p>这时发现PHP版本是5.4的，原因是yum默认的epel-release源太低了，而我需要部署的网站是基于Laravel5.5开发的，环境要求：</p>
<blockquote>
<ul>
<li><em>PHP &gt;= 7.0.0</em>   需要重新安装PHP7</li>
</ul>
</blockquote>
<blockquote>
<ul>
<li>PHP OpenSSL 扩展</li>
</ul>
</blockquote>
<blockquote>
<ul>
<li>PHP PDO 扩展</li>
</ul>
</blockquote>
<blockquote>
<ul>
<li>PHP Mbstring 扩展</li>
</ul>
</blockquote>
<blockquote>
<ul>
<li>PHP Tokenizer 扩展</li>
</ul>
</blockquote>
<blockquote>
<ul>
<li>PHP XML 扩展</li>
</ul>
</blockquote>
<p>删除之前安装的PHP版本</p>
<pre><code>
yum remove php* php-common

</code></pre>
<p>我们需要更换下rpm源，搜索epel-release源并删除后进行更新</p>
<pre><code>
[root@iZbp17dq2xryqoixibq5u1Z ~]# rpm -qa | grep epel

epel-release-7-11.noarch

[root@iZbp17dq2xryqoixibq5u1Z ~]# rpm -e epel-release-7-11.noarch

warning: /etc/yum.repos.d/epel.repo saved as /etc/yum.repos.d/epel.repo.rpmsave

[root@iZbp17dq2xryqoixibq5u1Z ~]# rpm -Uvh https://mirror.webtatic.com/yum/el7/epel-release.rpm

Retrieving https://mirror.webtatic.com/yum/el7/epel-release.rpm

warning: /var/tmp/rpm-tmp.PHnPwl: Header V4 RSA/SHA1 Signature, key ID 62e74ca5: NOKEY

Preparing...                          ################################# [100%]

Updating / installing...

   1:epel-release-7-5                 ################################# [100%]

[root@iZbp17dq2xryqoixibq5u1Z ~]# rpm -Uvh https://mirror.webtatic.com/yum/el7/webtatic-release.rpm

Retrieving https://mirror.webtatic.com/yum/el7/webtatic-release.rpm

warning: /var/tmp/rpm-tmp.ohTozh: Header V4 RSA/SHA1 Signature, key ID 62e74ca5: NOKEY

Preparing...                          ################################# [100%]

Updating / installing...

   1:webtatic-release-7-3             ################################# [100%]

</code></pre>
<p>重新安装PHP和一些相关扩展</p>
<pre><code>
yum install php72w-cli.x86_64 php72w-common.x86_64 php72w-gd.x86_64 php72w-ldap.x86_64 php72w-mbstring.x86_64 php72w-pdo.x86_64

</code></pre>
<p>安装PHP-FPM</p>
<pre><code>
yum install php72w-fpm

</code></pre>
<p>再次查看PHP版本</p>
<pre><code>
[root@iZbp17dq2xryqoixibq5u1Z ~]# php -v

PHP 7.2.4 (cli) (built: Mar 30 2018 08:49:13) ( NTS )

Copyright (c) 1997-2018 The PHP Group

Zend Engine v3.2.0, Copyright (c) 1998-2018 Zend Technologies

</code></pre>
<p>启动PHP-FPM</p>
<pre><code>
systemctl start php-fpm

systemctl enable php-fpm.service   开机自启动

</code></pre>
<p>常用命令：</p>
<blockquote>
<p>systemctl start php-fpm   # 启动</p>
</blockquote>
<blockquote></blockquote>
<blockquote>
<p>systemctl stop php-fpm   # 停止</p>
</blockquote>
<blockquote></blockquote>
<blockquote>
<p>systemctl restart php-fpm    # 重启</p>
</blockquote>
<blockquote></blockquote>
<blockquote>
<p>systemctl enable php-fpm    #开机自启动</p>
</blockquote>
<h1 id="三-安装nginx">三. 安装Nginx</h1>
<p><em>1. 开始Nginx</em></p>
<pre><code>
yum install nginx

</code></pre>
<p>安装完毕后，启动Nginx</p>
<pre><code>
systemctl start nginx

systemctl enable nginx    系统启动时自动启动Nginx

</code></pre>
<p>常用命令：</p>
<blockquote>
<p>fuser -k 80/tcp                     # 杀死80端口</p>
</blockquote>
<blockquote></blockquote>
<blockquote>
<p>nginx -s stop      # 停止</p>
</blockquote>
<blockquote></blockquote>
<blockquote>
<p>nginx -s reopen    # 重启</p>
</blockquote>
<blockquote></blockquote>
<blockquote>
<p>nginx -s reload    # 重新载入配置文件</p>
</blockquote>
<h1 id="四-网站部署">四. 网站部署</h1>
<p><em>1. 生成秘钥</em></p>
<pre><code>
ssh-keygen -t rsa

</code></pre>
<p>提示一直回车就行，将生成的秘钥添加到项目托管的git库网站上，因为我的网站是放在Coding上，我直接添加在了项目部署秘钥</p>
<p><em>2. 克隆项目</em></p>
<p>通过 <em>git clone</em> 命令将项目拉取到服务器上，我这边因为是Nginx，所以我拉取到 <em>/var/www/</em> 目录下，</p>
<p><em>3. 安装composer</em></p>
<pre><code>
[root@iZbp17dq2xryqoixibq5u1Z project_fjylhjjsyxgs]# curl -sS https://getcomposer.org/installer | php

All settings correct for using Composer

Downloading...



Composer (version 1.6.5) successfully installed to: /var/www/project_fjylhjjsyxgs/composer.phar

Use it: php composer.phar

</code></pre>
<p>移动composer.phar文件到/usr/local/bin目录下 ，使命令全局可用，并更换Packagist中国全量镜像</p>
<pre><code>
mv composer.phar /usr/local/bin/composer

composer config -g repo.packagist composer https://packagist.phpcomposer.com

</code></pre>
<p>通过composer安装项目依赖，但是出现了报错</p>
<pre><code>
[root@iZbp17dq2xryqoixibq5u1Z project_fjylhjjsyxgs]# composer install

Loading composer repositories with package information

Installing dependencies (including require-dev) from lock file

Your requirements could not be resolved to an installable set of packages.



  Problem 1

    - Installation request for phar-io/manifest 1.0.1 -&gt; satisfiable by phar-io/manifest[1.0.1].

    - phar-io/manifest 1.0.1 requires ext-dom * -&gt; the requested PHP extension dom is missing from your system.

  Problem 2

    - Installation request for phpunit/php-code-coverage 5.3.0 -&gt; satisfiable by phpunit/php-code-coverage[5.3.0].

    - phpunit/php-code-coverage 5.3.0 requires ext-dom * -&gt; the requested PHP extension dom is missing from your system.

  Problem 3

    - Installation request for phpunit/phpunit 6.5.7 -&gt; satisfiable by phpunit/phpunit[6.5.7].

    - phpunit/phpunit 6.5.7 requires ext-dom * -&gt; the requested PHP extension dom is missing from your system.

  Problem 4

    - Installation request for theseer/tokenizer 1.1.0 -&gt; satisfiable by theseer/tokenizer[1.1.0].

    - theseer/tokenizer 1.1.0 requires ext-dom * -&gt; the requested PHP extension dom is missing from your system.



  To enable extensions, verify that they are enabled in your .ini files:

    - /etc/php.ini

    - /etc/php.d/bz2.ini

    - /etc/php.d/calendar.ini

    - /etc/php.d/ctype.ini

    - /etc/php.d/curl.ini

    - /etc/php.d/exif.ini

    - /etc/php.d/fileinfo.ini

    - /etc/php.d/ftp.ini

    - /etc/php.d/gd.ini

    - /etc/php.d/gettext.ini

    - /etc/php.d/gmp.ini

    - /etc/php.d/iconv.ini

    - /etc/php.d/json.ini

    - /etc/php.d/ldap.ini

    - /etc/php.d/mbstring.ini

    - /etc/php.d/pdo.ini

    - /etc/php.d/pdo_sqlite.ini

    - /etc/php.d/phar.ini

    - /etc/php.d/shmop.ini

    - /etc/php.d/simplexml.ini

    - /etc/php.d/sockets.ini

    - /etc/php.d/sqlite3.ini

    - /etc/php.d/tokenizer.ini

    - /etc/php.d/xml.ini

    - /etc/php.d/zip.ini

  You can also run php --ini inside terminal to see which files are used by PHP in CLI mode.

</code></pre>
<p>Google后发现，php-xml扩展有以上需要的相关软件包</p>
<pre><code>
yum install php72w-xml.x86_64

</code></pre>
<p>重新执行composer install命令，依赖下载成功</p>
<p>开始配置Nginx配置</p>
<p>我本机<em>homestead</em>中的Nginx是通过 <em>/etc/nginx/sites-available</em> 目录设置对应多域名的nginx配置文件，但是不知道服务器上安装的Nginx，却没有这个目录，所以查看了下Nginx.conf文件，发现http模块中有如下一条配置</p>
<pre><code>
 本机homestead中Nginx.conf

 ##

    # Virtual Host Configs

    ##

    include /etc/nginx/conf.d/*.conf;

    include /etc/nginx/sites-enabled/*;

    

    服务器上安装的Nginx.conf

 # Load modular configuration files from the /etc/nginx/conf.d directory.

    # See http://nginx.org/en/docs/ngx_core_module.html#include

    # for more information.

    include /etc/nginx/conf.d/*.conf;

</code></pre>
<p>那好吧，我估计sites-available也是软连接的conf.d或者sites-enabled目录吧，所以我就直接将官方手册中Nginx配置复制了一份到/etc/nginx/conf.d/域名.conf，修改了一些配置</p>
<pre><code>
server {

    listen 80;

    server_name 域名或公网IP;

    root 项目地址指向到public目录;



    add_header X-Frame-Options &quot;SAMEORIGIN&quot;;

    add_header X-XSS-Protection &quot;1; mode=block&quot;;

    add_header X-Content-Type-Options &quot;nosniff&quot;;



    index index.html index.htm index.php;



    charset utf-8;



    location / {

        try_files uri uri/ /index.php?$query_string;

    }



    location = /favicon.ico { access_log off; log_not_found off; }

    location = /robots.txt  { access_log off; log_not_found off; }



    error_page 404 /index.php;



    location ~ .php$ {

        fastcgi_split_path_info ^(.+.php)(/.+)$;

        fastcgi_pass unix:/var/run/php/php7.2-fpm.sock;    这里有个坑下面讲

        fastcgi_index index.php;

        include fastcgi_params;

    }



    location ~ /.(?!well-known).* {

        deny all;

    }

}

</code></pre>
<p>配置完毕，保存退出，通过域名访问，发现报502错误，查看下Nginx的错误日志，发现报如下错误</p>
<pre><code>
2018/05/06 20:17:37 [crit] 5898#0: *66 connect() to unix:/var/run/php/php7.2-fpm.sock failed (2: No such file or directory) while connecting to upstream,

</code></pre>
<p>简单的讲下，php-fpm.sock文件就是让Nginx和PHP-FPM的进程间进行通信的文件，具体的含义，这边就不做详细介绍了。进这个目录查看下是否存在这个目录或文件，发现两个问题：</p>
<ul>
<li>
<p>目录错误，不是/var/run/php，而是/var/run/php-fpm</p>
</li>
<li>
<p>php7.2-fpm.sock这个文件未生成</p>
</li>
</ul>
<p><em>未生成原因</em>：php5.3之后的版本，php-fpm.conf里的listen的默认配置是127.0.0.1:9000，也就是tcp的方式，不会生成php-fpm.sock。</p>
<p>因为这次上线的网站没有什么并发量，unix socket方式要比tcp的方式快而且消耗资源少，所以我还是采用unix socket方式。定位到问题后，修改下 <em>/etc/php-fpm.d/www.conf</em>，也就是php-fpm的配置文件，关闭原来的listen方式，然后重启下php-fpm</p>
<pre><code>
;listen = 127.0.0.1:9000

listen = /var/run/php-fpm/php7.2-fpm.sock

</code></pre>
<p>这个时候，由于职业习惯，想把Nginx也重启下，然后就又碰到了一个问题</p>
<pre><code>
[root@iZbp17dq2xryqoixibq5u1Z project_fjylhjjsyxgs]# nginx -s stop

[root@iZbp17dq2xryqoixibq5u1Z project_fjylhjjsyxgs]# nginx -s reload

nginx: [error] open() &quot;/run/nginx.pid&quot; failed (2: No such file or directory)

</code></pre>
<p>这应该是因为把Nginx进程杀死后pid丢失了，下一次再开启nginx -s reload时无法启动。再次面向Google编程，发现还有挺多人碰到这个问题，所以解决方法马上就能搜索到了，执行如下命令</p>
<pre><code>
nginx -c /etc/nginx/nginx.conf

nginx -s reload

</code></pre>
<p>ok，接着Navicat远程连接到服务器数据库，source下数据库完毕。现看起来应该是可以跑起网站来了。再次访问域名，发现还是502，再次查看Nginx日志，报如下错误：</p>
<pre><code>
2018/05/06 20:37:00 [crit] 6078#0: *1 connect() to unix:/var/run/php-fpm/php7.2-fpm.sock failed (13: Permission denied) while connecting to upstream,

</code></pre>
<p>和上面报错看起来差不多，但是这次主要问题出在跑Nginx的用户是Nginx，而php-fpm.sock这个文件，监听的Nginx用户没有该权限，导致Nginx无法访问php-fpm.sock这个文件，自然监听就失去了效果，再次修改php-fpm配置文件和重启下php-fpm</p>
<pre><code>
; Set permissions for unix socket, if one is used. In Linux, read/write

; permissions must be set in order to allow connections from a web server. Many

; BSD-derived systems allow connections regardless of permissions.

; Default Values: user and group are set as the running user

;                 mode is set to 0660

listen.owner = nginx

listen.group = nginx

listen.mode = 0660

</code></pre>
<p>重新访问下域名，发现访问任何路由都是白屏，这次状态码都是200了，但是没有任何输出，再次面向Google编程……发现问题：</p>
<blockquote>
<p>由于nginx与php-fpm之间的一个小bug，会导致这样的现象： 网站中的静态页面 .html 都能正常访问，而 .php 文件虽然会返回200状态码， 但实际输出给浏览器的页面内容却是空白。 简而言之，原因是nginx无法正确的将 *.php 文件的地址传递给php-fpm去解析， 相当于php-fpm接受到了请求，但这请求却指向一个不存在的文件，于是返回空结果。 为了解决这个问题，需要改动nginx默认的fastcgiparams配置文件</p>
</blockquote>
<p>在 <em>/etc/nginx/fastcgi_params</em> 文件的最后增加两行：</p>
<pre><code>
fastcgi_param SCRIPT_FILENAME  document_rootfastcgi_script_name;  

fastcgi_param PATH_INFO     $fastcgi_script_name;  

</code></pre>
<p>再再再次访问域名，终于正常显示了，但是页面上又出现了新的错误：</p>
<blockquote>
<p><em>could not find driver（select * from users where deleted = 0）</em></p>
</blockquote>
<p>任何有sql查询的页面都报如上错误，这个错误多半是因为pdo_mysql未打开或者未安装此模块造成，执行 <em>php -m</em> 发现还真没装，安装php72w-mysql的又遇到一个坑</p>
<pre><code class="language-shell">
yum install php72w-mysql

</code></pre>
<p>报如下错误，说缺少libmysqlclient.so.18依赖</p>
<pre><code>
......

error: package: php72w-mysql 

requires: libmysqlclient.so.18(libmysqlclient_18)(64bit)

Available: 1:mariadb-libs-5.5.52-1.el7.x86_64 (base)

           libmysqlclient.so.18(libmysqlclient_18)(64bit)

......

</code></pre>
<p>这就很奇怪了，查看用户库文件目录内libmysqlclient.so.18已经存在</p>
<pre><code>
[root@iZbp17dq2xryqoixibq5u1Z ~]# ll /usr/lib64/mysql/libmysqlclient.so.18

libmysqlclient.so.18      libmysqlclient.so.18.1.0

</code></pre>
<p>这个坑花了一个小时，Google多次尝试无果后，认真思考下可能的原因，想了想可能是mysql版本的问题，修改下 <em>/etc/yum.repos.d/mysql-community.repo</em> 配置文件，将5.6的enabled设为1，5.5设为0，更新Mysql版本后，再次执行 <em>yum install php72w-mysql</em> 成功安装pdo_mysql模块…...</p>
<h1 id="至此网站访问终于成功">至此，网站访问终于成功！</h1>
<p>后续的部署优化，另外开篇记录。</p>
</li>
</ul>

                        </p>
                    </div>

                </div>
            </article>

            <section class="comments-area">
    <div class="inner">
        <h2 class="screen-reader-text">评论</h2>
        
            
                <div id="gitalk-container"></div>
            

            
        
    </div>
</section>


            
                <nav class="post-navigation">
                    <h2 class="screen-reader-text">Post navigation</h2>
                    <div class="nav-links">
                        <a href="https://zhangajian.com/post/php-de-ruan-jian-bao-guan-li-xi-tong-composer" class="nav-previous">
                            <div class="nav-bg" >
                                
                                    <img srcset="https://blog-img-hosting.oss-cn-shanghai.aliyuncs.com/blog/article_cover/c_42.jpg 300w, https://blog-img-hosting.oss-cn-shanghai.aliyuncs.com/blog/article_cover/c_42.jpg 600w, https://blog-img-hosting.oss-cn-shanghai.aliyuncs.com/blog/article_cover/c_42.jpg 800w, https://blog-img-hosting.oss-cn-shanghai.aliyuncs.com/blog/article_cover/c_42.jpg 1600w, https://blog-img-hosting.oss-cn-shanghai.aliyuncs.com/blog/article_cover/c_42.jpg 2000w" sizes="(max-width: 800px) 100vw, 50vw" src="https://blog-img-hosting.oss-cn-shanghai.aliyuncs.com/blog/article_cover/c_42.jpg" alt="图裂了"/>
                                
                            </div>
                            <div class="nav-inside">
                                <span class="nav-before">下一篇</span>
                                <span class="nav-title">PHP的软件包管理系统-Composer</span>
                                <span class="nav-date">2017-10-07</span>
                            </div>
                        </a>
                    </div>
                </nav>
            

        </div>
    </main>

    <footer class="site-footer">
    <div class="inner">
        <!-- 社交 -->
        <div class="offsite-links">
            
                
            
                
            
                
            
                
            
                
            
        </div>

        <div class="site-info">
          THEME BY <a href="">Subtle</a><br/>
          Powered by <a target="_blank" href="https://gridea.dev/">Gridea</a>, © 2016 - 2019 Copyright 张阿简. All Rights Reserved. 自制主题<a target="_blank" href="https://github.com/GalaxySuze/gridea-theme-space">Space For Gridea</a>
        </div>
        <a href="#page" class="arrow-up" data-scroll><span class="screen-reader-text">Back to the top</span></a>
    </div>
</footer>


</div>

<script src="https://zhangajian.com/media/scripts/_core/plugins.js"></script>
<script src="https://zhangajian.com/media/scripts/_core/custom.js"></script>

<!-- highlight -->
<script src="https://cdn.bootcss.com/highlight.js/9.15.8/highlight.min.js"></script>
<!-- Md5 Min JS -->
<script src="https://zhangajian.com/media/scripts/_vendors/md5.min.js"></script>

<script type="application/javascript">
    // 代码高亮
    hljs.initHighlightingOnLoad();

</script>



    
        <script src="https://cdn.bootcss.com/gitalk/1.5.0/gitalk.min.js"></script>
        <script>

            var gitalk = new Gitalk({
                clientID: 'f82af725bc4967d0e195',
                clientSecret: 'ea48b3d1484e6658649b97c3de3dd33e0ca89a64',
                repo: 'ZhangAJianBlogGitalk',
                owner: 'GalaxySuze',
                admin: ['GalaxySuze'],
                id: md5(location.pathname),      // Ensure uniqueness and length less than 50
                distractionFreeMode: false  // Facebook-like distraction free mode
            })

            gitalk.render('gitalk-container')

        </script>
    

    





</body>
</html>
